<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Editor de Pesquisas - FEEDPro</title>
    <link rel="stylesheet" href="/css/style.css">
    <link rel="stylesheet" href="/css/dashboard.css">
    <link rel="stylesheet" href="/css/clients.css">
    <style>
        textarea {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            min-height: 80px;
            resize: vertical;
        }
    </style>
</head>
<body>
    <div class="dashboard-layout">
        <aside class="sidebar">
            <div class="sidebar-header">
                <img src="/images/feedpro_png_1.png" alt="FEEDPro" class="sidebar-logo">
            </div>
            
            <nav class="sidebar-nav">
                <div class="nav-section">
                    <span class="nav-label">NAVEGAÇÃO</span>
                    <a href="/dashboard" class="nav-item">
                        <img src="/images/Icon_dashboard.svg" alt="" class="nav-icon">
                        <span>Dashboard</span>
                    </a>
                    <a href="/clients" class="nav-item">
                        <img src="/images/Icon_profile.svg" alt="" class="nav-icon">
                        <span>Base de Clientes</span>
                    </a>
                    <a href="/surveys" class="nav-item active">
                        <img src="/images/Icon_editor_pesquisas.svg" alt="" class="nav-icon">
                        <span>Editor de Pesquisas</span>
                    </a>
                    <a href="/send-surveys" class="nav-item">
                        <img src="/images/Icon_disparar.svg" alt="" class="nav-icon">
                        <span>Disparar Pesquisas</span>
                    </a>
                    <a href="#" class="nav-item">
                        <img src="/images/Icon_metricas.svg" alt="" class="nav-icon">
                        <span>Métricas e Resultados</span>
                    </a>
                    <a href="/ai-analysis" class="nav-item">
                        <img src="/images/Icon_ia.svg" alt="" class="nav-icon">
                        <span>Análise de IA</span>
                    </a>
                </div>
                <div class="nav-section nav-footer">
                    <a href="#" class="nav-item nav-logout" onclick="logout(); return false;">
                        <span>Sair</span>
                    </a>
                </div>
            </nav>
        </aside>

        <div class="main-content">
            <header class="page-header">
                <div>
                    <h1>Editor de Pesquisas</h1>
                    <p class="subtitle">Crie e gerencie suas pesquisas de satisfação</p>
                </div>
                <div style="display: flex; align-items: center; gap: 20px;">
                    <div style="text-align: right;">
                        <p style="color: #6b7280; font-size: 12px; margin-bottom: 2px;">Usuário:</p>
                        <p style="color: #1f2937; font-size: 14px; font-weight: 600;" id="userName">Carregando...</p>
                    </div>
                    <button class="btn-new-client" onclick="showForm()">
                        + Nova Pesquisa
                    </button>
                </div>
            </header>

            <div class="alert alert-success" id="alertSuccess" style="display: none; margin-bottom: 20px; padding: 15px; background: #d1fae5; color: #065f46; border-radius: 8px;"></div>
            <div class="alert alert-error" id="alertError" style="display: none; margin-bottom: 20px; padding: 15px; background: #fee2e2; color: #991b1b; border-radius: 8px;"></div>

            <div class="clients-table-container" id="formSection" style="display: none;">
                <h3 id="formTitle">Nova Pesquisa</h3>
                <form id="surveyForm" style="padding: 20px;">
                    <input type="hidden" id="surveyId">

                    <div class="form-row">
                        <div class="form-group" style="flex: 1;">
                            <label for="title">Título *</label>
                            <input type="text" id="title" required placeholder="Digite o título da pesquisa">
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group" style="flex: 1;">
                            <label for="description">Descrição</label>
                            <textarea id="description" placeholder="Digite a descrição da pesquisa"></textarea>
                        </div>
                    </div>

                    <div class="form-actions">
                        <button type="button" class="btn-cancel" onclick="hideForm()">Cancelar</button>
                        <button type="submit" class="btn-save">Salvar Pesquisa</button>
                    </div>
                </form>
            </div>

            <div class="clients-table-container">
                <h3>Lista de Pesquisas</h3>
                <table class="clients-table">
                    <thead>
                        <tr>
                            <th>Título</th>
                            <th>Descrição</th>
                            <th>Status</th>
                            <th>Ações</th>
                        </tr>
                    </thead>
                    <tbody id="surveysTableBody">
                        <tr>
                            <td colspan="4" style="text-align: center;">Carregando...</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

<script>

    const API_URL = '/api/surveys';

    document.addEventListener('DOMContentLoaded', async () => {
        await checkSession();
        loadSurveys();
    });

    function getAuthHeaders() {
        const token = localStorage.getItem('token');
        if (!token) {
            window.location.href = '/login';
            return null;
        }
        return {
            'Authorization': `Bearer ${token}`,
            'Content-Type': 'application/json'
        };
    }

    async function checkSession() {
        const token = localStorage.getItem('token');
        if (!token) {
            window.location.href = '/login';
            return;
        }

        try {
            const response = await fetch('/api/auth/check', {
                headers: getAuthHeaders()
            });
            
            if (response.ok) {
                const admin = await response.json();
                document.getElementById('userName').textContent = admin.name;
            } else {
                localStorage.clear();
                window.location.href = '/login';
            }
        } catch (error) {
            localStorage.clear();
            window.location.href = '/login';
        }
    }

    async function logout() {
        try {
            const token = localStorage.getItem('token');
            if (token) {
                await fetch('/api/auth/logout', { 
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
            }
        } catch (error) {
            console.error('Erro ao fazer logout', error);
        } finally {
            localStorage.clear();
            window.location.href = '/login';
        }
    }

    async function loadSurveys() {
        try {
            const response = await fetch(API_URL, {
                headers: getAuthHeaders()
            });
            const surveys = await response.json();

            const tbody = document.getElementById('surveysTableBody');

            if (surveys.length === 0) {
                tbody.innerHTML = '<tr><td colspan="4" style="text-align: center;">Nenhuma pesquisa cadastrada</td></tr>';
                return;
            }

            tbody.innerHTML = surveys.map(survey => `
                    <tr>
                        <td>${survey.title}</td>
                        <td>${survey.description || '-'}</td>
                        <td>
                            <span style="padding: 4px 12px; border-radius: 12px; font-size: 12px; font-weight: 500; ${survey.active ? 'background: #d1fae5; color: #065f46;' : 'background: #fee2e2; color: #991b1b;'}">
                                ${survey.active ? 'Ativa' : 'Inativa'}
                            </span>
                        </td>
                        <td>
                            <div style="display: flex; gap: 8px;">
                                <button onclick="editSurvey(${survey.id})" style="padding: 6px 12px; background: #3b82f6; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 13px;">Editar</button>
                                <button onclick="toggleActive(${survey.id})" style="padding: 6px 12px; background: ${survey.active ? '#f59e0b' : '#10b981'}; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 13px;">
                                    ${survey.active ? 'Desativar' : 'Ativar'}
                                </button>
                                <button onclick="deleteSurvey(${survey.id})" style="padding: 6px 12px; background: #ef4444; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 13px;">Excluir</button>
                            </div>
                        </td>
                    </tr>
                `).join('');
        } catch (error) {
            showError('Erro ao carregar pesquisas');
            console.error(error);
        }
    }

    function showForm() {
        document.getElementById('formSection').style.display = 'block';
        document.getElementById('formTitle').textContent = 'Nova Pesquisa';
        document.getElementById('surveyForm').reset();
        document.getElementById('surveyId').value = '';
    }

    function hideForm() {
        document.getElementById('formSection').style.display = 'none';
        document.getElementById('surveyForm').reset();
    }

    document.getElementById('surveyForm').addEventListener('submit', async (e) => {
        e.preventDefault();

        const surveyId = document.getElementById('surveyId').value;
        const data = {
            title: document.getElementById('title').value,
            description: document.getElementById('description').value
        };

        try {
            const url = surveyId ? `${API_URL}/${surveyId}` : API_URL;
            const method = surveyId ? 'PUT' : 'POST';

            const response = await fetch(url, {
                method: method,
                headers: getAuthHeaders(),
                body: JSON.stringify(data)
            });

            if (response.ok) {
                showSuccess(surveyId ? 'Pesquisa atualizada com sucesso!' : 'Pesquisa cadastrada com sucesso!');
                hideForm();
                loadSurveys();
            } else {
                const errorText = await response.text();
                showError(errorText || 'Erro ao salvar pesquisa');
            }
        } catch (error) {
            showError('Erro ao salvar pesquisa');
            console.error(error);
        }
    });

    async function editSurvey(id) {
        try {
            const response = await fetch(`${API_URL}/${id}`, {
                headers: getAuthHeaders()
            });
            const survey = await response.json();

            document.getElementById('surveyId').value = survey.id;
            document.getElementById('title').value = survey.title;
            document.getElementById('description').value = survey.description || '';

            document.getElementById('formTitle').textContent = 'Editar Pesquisa';
            document.getElementById('formSection').style.display = 'block';
        } catch (error) {
            showError('Erro ao carregar pesquisa');
            console.error(error);
        }
    }

    async function toggleActive(id) {
        try {
            const response = await fetch(`${API_URL}/${id}/toggle-active`, {
                method: 'PATCH',
                headers: getAuthHeaders()
            });

            if (response.ok) {
                showSuccess('Status alterado com sucesso!');
                loadSurveys();
            } else {
                showError('Erro ao alterar status');
            }
        } catch (error) {
            showError('Erro ao alterar status');
            console.error(error);
        }
    }

    async function deleteSurvey(id) {
        if (!confirm('Tem certeza que deseja excluir esta pesquisa? Isso pode apagar respostas associadas.')) {
            return;
        }

        try {
            const response = await fetch(`${API_URL}/${id}`, {
                method: 'DELETE',
                headers: getAuthHeaders()
            });

            if (response.ok) {
                showSuccess('Pesquisa excluída com sucesso!');
                loadSurveys();
            } else {
                showError('Erro ao excluir pesquisa');
            }
        } catch (error) {
            showError('Erro ao excluir pesquisa');
            console.error(error);
        }
    }

    function showSuccess(message) {
        const alert = document.getElementById('alertSuccess');
        alert.textContent = message;
        alert.style.display = 'block';
        setTimeout(() => {
            alert.style.display = 'none';
        }, 3000);
    }

    function showError(message) {
        const alert = document.getElementById('alertError');
        alert.textContent = message;
        alert.style.display = 'block';
        setTimeout(() => {
            alert.style.display = 'none';
        }, 3000);
    }
</script>
</body>
</html>